<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AmeriClean Intel Hub — Admin</title>
<meta name="color-scheme" content="dark">
<style>
:root{--bg:#0b0f14;--panel:#0f1622;--muted:#9ab0c4;--text:#e8f1f8;--line:#1a2740;--hi:#7afcff;--hi2:#4bb3fd;--good:#16c784;--warn:#ffcc00;--bad:#ff6b6b}
*{box-sizing:border-box}body{margin:0;background:#0b0f14;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
a{color:#9ed0ff;text-decoration:none}
.topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0d1420;border-bottom:1px solid #1a2740}
.logo{width:28px;height:28px;border-radius:8px;background:#0e1726;display:grid;place-items:center;font-weight:700}
.layout{display:grid;grid-template-columns:260px 1fr;gap:0;min-height:100dvh}
.sidebar{background:#0e1522;border-right:1px solid #1a2740;padding:12px;position:sticky;top:48px;height:calc(100dvh - 48px);overflow:auto}
.side-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid #1a2740;background:#0f1928}
.side-item.active{outline:1px solid #30507a}
.main{padding:16px}
.card{background:#0f1622;border:1px solid #1a2740;border-radius:14px;padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.kpi{display:flex;flex-direction:column;gap:4px;padding:10px;border:1px solid #1b2942;border-radius:12px;background:linear-gradient(180deg,#101827,#0f1726)}
.pill{border:1px solid #2a3a58;background:#0d1522;color:#cfe3f7;padding:4px 8px;border-radius:999px}
.pill.warn{border-color:#735b00;background:#2b2300;color:#ffe38a}
.btn{cursor:pointer;padding:6px 10px;border-radius:8px;border:1px solid #28436a;background:#0f1a2a;color:#cfe3f7}
.input{width:100%;padding:8px;border-radius:8px;border:1px solid #24324e;background:#0f1827;color:#dff0ff}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #20314f}th{background:#0f1a2a;color:#bfe0ff;text-align:left}
.small{font-size:12px;color:#9ab0c4}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid #204060;background:#132033}
</style>
<script src="assets/config.js"></script>
</head>
<body>
<div class="topbar">
  <div class="logo">AC</div><b>AmeriClean Intel Hub — Admin</b>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <input id="searchBox" class="input" style="width:280px" placeholder="Search competitors…">
    <label class="pill" style="display:flex;align-items:center;gap:6px"><input id="toggleLive" type="checkbox"> Live (keywords)</label>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <div class="small" style="margin:8px 0">Navigation</div>
    <div class="side-item active" data-page="dashboard">Dashboard</div>
    <div class="side-item" data-page="competitors">Competitors</div>
    <div class="side-item" data-page="keywords">Local Keywords</div>
    <div class="side-item" data-page="planner">PPC Planner</div>
    <div class="side-item" data-page="settings">Settings</div>

    <div class="small" style="margin:12px 0 6px">Add competitor</div>
    <input id="newName" class="input" placeholder="Company">
    <input id="newCity" class="input" placeholder="City, ST" style="margin-top:6px">
    <input id="newWebsite" class="input" placeholder="https://example.com" style="margin-top:6px">
    <button id="btnAdd" class="btn" style="margin-top:6px">Add</button>
    <div id="addMsg" class="small" style="margin-top:6px"></div>
  </aside>

  <main class="main">
    <div id="page"></div>
  </main>
</div>

<script id="seed" type="application/json">{"companies": [{"id": "servpro-billings", "name": "SERVPRO of Billings", "logo": "SP", "website": "https://www.servpro.com/locations/mt/servpro-of-billings", "city": "Billings, MT", "threatRank": 1, "kpis": {"seo": 78, "rating": 4.7, "reviews": 265, "adSpend": 20000, "localPack": 1, "price": 4.0, "quality": 4.7}, "mix": {"seo": 42, "paid": 38, "social": 10, "referral": 10}, "ratingBreakdown": {"5\u2605": 210, "4\u2605": 35, "3\u2605": 10, "2\u2605": 5, "1\u2605": 5}, "keywords": [["water damage billings", 1], ["fire restoration billings", 1], ["mold remediation billings", 2]], "trends": {"months": ["Mar", "Apr", "May", "Jun", "Jul", "Aug"], "adSpend": [19000, 19500, 20000, 20500, 20500, 21000], "seo": [75, 76, 77, 78, 78, 78], "localPack": [1, 1, 1, 1, 1, 1]}}, {"id": "servicemaster-bigsky", "name": "ServiceMaster by Big Sky", "logo": "SM", "website": "https://www.servicemasterrestore.com/servicemaster-by-big-sky-billings/", "city": "Billings, MT", "threatRank": 2, "kpis": {"seo": 70, "rating": 4.6, "reviews": 180, "adSpend": 12000, "localPack": 2, "price": 4.0, "quality": 4.5}, "mix": {"seo": 38, "paid": 40, "social": 12, "referral": 10}, "ratingBreakdown": {"5\u2605": 140, "4\u2605": 25, "3\u2605": 10, "2\u2605": 3, "1\u2605": 2}, "keywords": [["water damage billings", 3], ["mold removal billings", 2]], "trends": {"months": ["Mar", "Apr", "May", "Jun", "Jul", "Aug"], "adSpend": [11500, 11800, 12000, 12200, 12000, 12500], "seo": [68, 68, 69, 70, 70, 70], "localPack": [2, 2, 2, 2, 2, 2]}}, {"id": "americlean", "name": "AmeriClean (You)", "logo": "AC", "website": "https://www.americlean9111.com", "city": "Billings, MT", "threatRank": 3, "kpis": {"seo": 34, "rating": 4.9, "reviews": 112, "adSpend": 3000, "localPack": 3, "price": 3.0, "quality": 4.5}, "mix": {"seo": 36, "paid": 18, "social": 20, "referral": 26}, "ratingBreakdown": {"5\u2605": 84, "4\u2605": 14, "3\u2605": 7, "2\u2605": 4, "1\u2605": 3}, "keywords": [["water damage billings", 9], ["mold remediation billings", 7]], "trends": {"months": ["Mar", "Apr", "May", "Jun", "Jul", "Aug"], "adSpend": [2500, 2600, 2700, 2800, 2900, 3000], "seo": [28, 30, 31, 33, 34, 34], "localPack": [4, 4, 3, 3, 3, 3]}}, {"id": "alpha-omega", "name": "Alpha-Omega Disaster Restoration", "logo": "AO", "website": "https://www.alphaomegapros.com", "city": "Billings, MT", "threatRank": 4, "kpis": {"seo": 55, "rating": 4.8, "reviews": 95, "adSpend": 5000, "localPack": 3, "price": 3.0, "quality": 4.3}, "mix": {"seo": 40, "paid": 25, "social": 15, "referral": 20}, "ratingBreakdown": {"5\u2605": 78, "4\u2605": 10, "3\u2605": 5, "2\u2605": 1, "1\u2605": 1}, "keywords": [["water damage repair billings", 4], ["fire damage cleanup billings", 3]], "trends": {"months": ["Mar", "Apr", "May", "Jun", "Jul", "Aug"], "adSpend": [4500, 4700, 5000, 5000, 5100, 5200], "seo": [53, 53, 54, 55, 55, 55], "localPack": [3, 3, 3, 3, 3, 3]}}]}</script>
<script id="econ" type="application/json">{"Water Damage": {"closeRate": 0.35, "grossMargin": 0.45, "avgTicket": 3500}, "Mold Remediation": {"closeRate": 0.3, "grossMargin": 0.5, "avgTicket": 4200}, "Fire Damage": {"closeRate": 0.25, "grossMargin": 0.4, "avgTicket": 8000}, "General Restoration": {"closeRate": 0.4, "grossMargin": 0.35, "avgTicket": 900}}</script>
<script id="kwseed" type="application/json">[{"keyword": "water damage billings", "volume": 900, "cpc": 16.5, "intent": "Emergency", "service": "Water Damage"}, {"keyword": "water damage restoration billings", "volume": 550, "cpc": 14.2, "intent": "Emergency", "service": "Water Damage"}, {"keyword": "mold remediation billings", "volume": 300, "cpc": 11.3, "intent": "Service", "service": "Mold Remediation"}, {"keyword": "fire damage cleanup billings", "volume": 180, "cpc": 12.9, "intent": "Service", "service": "Fire Damage"}, {"keyword": "sewage cleanup billings", "volume": 110, "cpc": 13.5, "intent": "Emergency", "service": "Water Damage"}, {"keyword": "dry out service billings", "volume": 90, "cpc": 9.8, "intent": "Service", "service": "Water Damage"}, {"keyword": "smoke odor removal billings", "volume": 80, "cpc": 8.5, "intent": "Service", "service": "Fire Damage"}, {"keyword": "basement flood cleanup billings", "volume": 120, "cpc": 15.5, "intent": "Emergency", "service": "Water Damage"}]</script>
<script>
// ----- Data & Config -----
var DATA = JSON.parse(document.getElementById('seed').textContent);
var ECON = JSON.parse(document.getElementById('econ').textContent);
var KWSEED = JSON.parse(document.getElementById('kwseed').textContent);
var LIVE=false;
var API_GIST = (window.KEYWORD_JSON_URL||'').trim(); // Optional: any JSON URL (GitHub raw, Gist, etc.)

// ----- Utils & Micro charts (SVG only) -----
var fmt={money:(v)=>'$'+(Math.round(v).toLocaleString()), pct:(v)=> (Math.round(v*100))+'%', one:(n)=>Math.round(n)};
function el(t,a){var e=document.createElement(t);a=a||{};for(var k in a){if(k==='class')e.className=a[k];else if(k==='html')e.innerHTML=a[k];else e.setAttribute(k,a[k]);}for(var i=2;i<arguments.length;i++){var ch=arguments[i];if(ch==null)continue;if(typeof ch==='string')e.appendChild(document.createTextNode(ch));else e.appendChild(ch);}return e;}
function bar(w,h,vals,labels){var m=Math.max.apply(null,vals.concat([1])),bw=Math.floor((w-40)/vals.length)-6,x=30,b='';for(var i=0;i<vals.length;i++){var v=vals[i],bh=Math.max(2,Math.round((v/m)*(h-40))),y=h-bh-20;b+='<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+bh+'" rx="3" ry="3" fill="url(#g)"></rect>';b+='<text x="'+(x+bw/2)+'" y="'+(h-6)+'" fill="#9fb7cc" font-size="11" text-anchor="middle">'+(labels?labels[i]:'')+'</text>';x+=bw+8;}return '<svg width="'+w+'" height="'+h+'"><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7afcff"/><stop offset="100%" stop-color="#4bb3fd"/></linearGradient></defs><rect x="0" y="0" width="'+w+'" height="'+h+'" rx="10" ry="10" fill="#0c1421" stroke="#1a2a45"/>'+b+'</svg>';}
function line(labels,series,w,h,title){w=w||520;h=h||220;title=title||'';var pad=36,max=Math.max.apply(null,series),min=Math.min.apply(null,series),range=(max-min)||1;function sx(i){return pad+(i/(labels.length-1))*(w-2*pad);}function sy(v){return h-pad-((v-min)/range)*(h-2*pad);}var p='';for(var i=0;i<series.length;i++){var x=sx(i),y=sy(series[i]);p+=(i?' L':'M')+x+' '+y;}var dots='';for(var j=0;j<series.length;j++){dots+='<circle cx="'+sx(j)+'" cy="'+sy(series[j])+'" r="3" fill="#7afcff" stroke="#14304f"/>'; }return '<svg width="'+w+'" height="'+h+'"><rect x="0" y="0" width="'+w+'" height="'+h+'" rx="10" ry="10" fill="#0c1421" stroke="#1a2a45"/><path d="'+p+'" fill="none" stroke="#7afcff" stroke-width="2"/>'+dots+'<text x="'+(w/2)+'" y="'+(h-8)+'" fill="#9fb7cc" font-size="12" text-anchor="middle">'+title+'</text></svg>';}

// ----- Keyword sourcing (backend-free) -----
// Priority: JSON URL (gist/raw) -> localStorage cache -> seed
async function fetchKeywords(city){
  const cacheKey='kw:'+city;
  if(LIVE && API_GIST){
    try{
      const r = await fetch(API_GIST, {mode:'cors'});
      if(r.ok){
        const json = await r.json();
        if(Array.isArray(json)){ localStorage.setItem(cacheKey, JSON.stringify(json)); return json; }
        if(Array.isArray(json.keywords)){ localStorage.setItem(cacheKey, JSON.stringify(json.keywords)); return json.keywords; }
      }
    }catch(e){ /* fall back */ }
  }
  try{
    const cached = localStorage.getItem(cacheKey);
    if(cached) return JSON.parse(cached);
  }catch(e){}
  return KWSEED; // fallback
}

// Trends embed (no key, relative) — returns an iframe node
function trendsEmbed(query, geo){
  var src = 'https://trends.google.com/trends/embed/explore?q='+encodeURIComponent(query)+'&geo='+(geo||'US-MT');
  var ifr = el('iframe',{src:src, width:'100%', height:'360', style:'border:0;background:#0f1622;border-radius:12px'});
  return ifr;
}

// ----- Pages -----
function navActivate(page){
  document.querySelectorAll('.side-item').forEach(n=> n.classList.toggle('active', n.getAttribute('data-page')===page));
  render(page);
}

function pageDashboard(){
  const wrap=el('div');
  const all=DATA.companies.slice().sort((a,b)=>a.threatRank-b.threatRank);
  const lead=all[0], me=DATA.companies.find(x=>x.id==='americlean')||all[0];
  const row=el('div',{class:'row3'});
  row.appendChild(el('div',{class:'kpi'}, el('div',null,'Top Threat'), el('b',null,lead.name), el('div',{class:'small'}, 'Local Pack #'+lead.kpis.localPack+' • SEO '+lead.kpis.seo)));
  row.appendChild(el('div',{class:'kpi'}, el('div',null,'AmeriClean Rating'), el('b',null,String(me.kpis.rating)), el('div',{class:'small'}, me.kpis.reviews+' reviews')));
  row.appendChild(el('div',{class:'kpi'}, el('div',null,'Spend Gap (vs top)'), el('b',null,fmt.money(Math.max(0,lead.kpis.adSpend - me.kpis.adSpend||0))), el('div',{class:'small'}, 'Monthly')));
  wrap.appendChild(row);

  const charts=el('div',{class:'row'});
  charts.appendChild(el('div',{class:'card'}, el('h3',null,'Top Threat Ad Spend (6 mo)'), el('div',{html:line(lead.trends.months, lead.trends.adSpend, 520, 240)})));
  charts.appendChild(el('div',{class:'card'}, el('h3',null,'AmeriClean SEO (6 mo)'), el('div',{html:line(me.trends.months, me.trends.seo||[0], 520, 240)})));
  wrap.appendChild(charts);
  return wrap;
}

function companyTile(c){
  const k=c.kpis;
  return el('div',{class:'card'},
    el('div',null, el('b',null,c.name), ' ', el('span',{class:'badge'}, c.city||'')),
    el('div',{class:'small'}, c.website||''),
    el('div',{html:bar(320,160,[k.seo, k.rating*20, k.reviews/10, k.adSpend/500], ['SEO','★','Rev','Ad$'])}),
    el('div',null, el('span',{class:'pill'}, 'Threat #'+c.threatRank), ' ', el('span',{class:'pill'}, 'Local Pack '+k.localPack))
  );
}

function pageCompetitors(){
  const wrap=el('div');
  const grid=el('div',{class:'row3'});
  DATA.companies.slice().sort((a,b)=>a.threatRank-b.threatRank).forEach(c=> grid.appendChild(companyTile(c)));
  wrap.appendChild(grid);

  // Detail + counter
  const sel = DATA.companies[0];
  wrap.appendChild(el('div',{class:'card', style:'margin-top:12px'},
    el('h3',null,'Counter-Strategy (AmeriClean vs '+sel.name+')'),
    counterBlock(sel)
  ));
  return wrap;
}

function econTable(){
  const t=el('table'); t.innerHTML='<tr><th>Service</th><th>Close Rate</th><th>Gross Margin</th><th>Avg Ticket</th><th>Gross Profit/Job</th></tr>';
  Object.keys(ECON).forEach(s=>{
    const e=ECON[s], gp = e.grossMargin * e.avgTicket;
    const tr=el('tr'); tr.appendChild(el('td',null,s)); tr.appendChild(el('td',null, fmt.pct(e.closeRate)));
    tr.appendChild(el('td',null, fmt.pct(e.grossMargin))); tr.appendChild(el('td',null, fmt.money(e.avgTicket)));
    tr.appendChild(el('td',null, fmt.money(gp))); t.appendChild(tr);
  });
  return t;
}

function counterPlanFor(c){
  const my = DATA.companies.find(x=>x.id==='americlean') || c;
  // Spend baseline: conservative
  const base = Math.max(2500, Math.round((c.kpis.adSpend*0.55) + (c.kpis.seo*32) + (c.kpis.reviews*3.5)));
  // Channel mix
  let mix={PPC:0.34, LSAs:0.20, LocalSEO:0.26, PaidSocial:0.10, CRO:0.10};
  if(c.kpis.localPack<=2){ mix={PPC:0.40,LSAs:0.25,LocalSEO:0.20,PaidSocial:0.10,CRO:0.05}; }
  if(my.kpis.rating > c.kpis.rating){ mix.LocalSEO+=0.05; mix.PPC-=0.05; }
  // Normalize
  const s=mix.PPC+mix.LSAs+mix.LocalSEO+mix.PaidSocial+mix.CRO; Object.keys(mix).forEach(k=> mix[k]=+(mix[k]/s).toFixed(2));
  // CPL targets per service (conservative)
  const cplTargets={};
  Object.keys(ECON).forEach(sv=>{
    const e=ECON[sv];
    const profitPerJob = e.grossMargin * e.avgTicket;
    const maxCAC = profitPerJob * 0.5; // invest up to 50% of gross profit per job
    const cpl = Math.round((maxCAC * e.closeRate)/3); // divide by 3 to stay conservative (lead->appt->job)
    cplTargets[sv]=cpl;
  });
  return {budget:base, mix:mix, cpl:cplTargets};
}

function counterBlock(c){
  const plan = counterPlanFor(c);
  const wrap=el('div');
  const row=el('div',{class:'row'});
  row.appendChild(el('div',{class:'kpi'}, el('div',null,'Recommended Monthly Budget'), el('b',null, fmt.money(plan.budget)), el('div',{class:'small'},'Conservative, tied to competitor strength')));
  const labels=Object.keys(plan.mix), vals=labels.map(k=> Math.round(plan.budget*plan.mix[k]));
  row.appendChild(el('div',{class:'kpi'}, el('div',null,'Spend Allocation'), el('div',{html:bar(420,160, vals, labels)})));
  wrap.appendChild(row);

  wrap.appendChild(el('div',{class:'row'},
    el('div',{class:'card'}, el('h3',null,'Service Economics (Conservative)'), econTable()),
    el('div',{class:'card'}, el('h3',null,'CPL Targets by Service'), cplTable(plan.cpl))
  ));
  wrap.appendChild(el('div',{class:'card'}, el('h3',null,'Tactics'),
    tacticList(c)
  ));
  return wrap;
}

function cplTable(cpl){ const t=el('table'); t.innerHTML='<tr><th>Service</th><th>Max CPL (target)</th></tr>';
  Object.keys(cpl).forEach(sv=>{ const tr=el('tr'); tr.appendChild(el('td',null,sv)); tr.appendChild(el('td',null,'$'+cpl[sv])); t.appendChild(tr); });
  return t;
}

function tacticList(c){
  const ul=el('ul'); [
    'GBP: add project photos weekly; Q&A seeding for water/fire/mold; services/badge completeness 100%.',
    'Reviews: +20 in 60 days; automated SMS/email; “review us” NFC card; reply to all within 24h.',
    'PPC: exact match for emergency terms; daypart 6pm–7am bid +35%; call-only ads at night; negative match “jobs/salaries”.',
    'LSAs: background checks complete; dispute low-quality leads; bid more on water emergency; enable messaging.',
    'SEO: build city + suburb pages; service pages for sewage cleanup, dry-out, smoke odor; internal link hub from homepage.',
    'CRO: sticky call button; hero with 60‑min arrival promise; trust badges; before/after gallery; financing badge.',
    'Paid Social: 20mi radius; storm alert templates; before/after reels; lead form with “free moisture check”.'
  ].forEach(t=> ul.appendChild(el('li',null,t)));
  return ul;
}

function pageKeywords(){
  const wrap=el('div');
  wrap.appendChild(el('div',{class:'row'},
    el('div',{class:'card'},
      el('h3',null,'Local Keyword Demand'),
      el('div',{class:'small'},'Source order: JSON URL (Settings) → Cache → Seed'),
      el('div',null, el('button',{class:'btn',id:'btnReload'},'Reload')),
      el('div',{id:'kwTableWrap'})
    ),
    el('div',{class:'card'},
      el('h3',null,'Google Trends (relative, no key)'),
      el('div',{class:'small'},'Shows relative interest for top keyword'),
      el('div',{id:'trendsWrap'})
    )
  ));
  // Upload JSON section
  wrap.appendChild(el('div',{class:'card', style:'margin-top:12px'},
    el('h3',null,'Upload keywords JSON (optional)'),
    el('div',{class:'small'},'Schema: [{"keyword":"water damage billings","volume":900,"cpc":16.5,"intent":"Emergency","service":"Water Damage"}, ...]'),
    el('input',{type:'file',id:'fileInput',accept:'.json'})
  ));
  setTimeout(()=> loadKeywordsUI(), 0);
  return wrap;
}

async function loadKeywordsUI(){
  const city = (DATA.companies.find(x=>x.id==='americlean')||{city:'Billings, MT'}).city;
  const kw = await fetchKeywords(city);
  const wrap = document.getElementById('kwTableWrap'); wrap.innerHTML='';
  const t=el('table'); t.innerHTML='<tr><th>Keyword</th><th>Monthly Volume</th><th>Est. CPC</th><th>Intent</th><th>Service</th></tr>';
  kw.forEach(r=>{ const tr=el('tr'); tr.appendChild(el('td',null,r.keyword)); tr.appendChild(el('td',null,String(r.volume||0))); tr.appendChild(el('td',null, r.cpc ? '$'+r.cpc.toFixed(2) : '—')); tr.appendChild(el('td',null,r.intent||'')); tr.appendChild(el('td',null,r.service||'')); t.appendChild(tr); });
  wrap.appendChild(t);
  const top = kw.slice().sort((a,b)=>(b.volume||0)-(a.volume||0))[0] || {keyword:'water damage billings'};
  const trends = document.getElementById('trendsWrap'); trends.innerHTML=''; trends.appendChild(trendsEmbed(top.keyword, 'US-MT'));
  // Hook PPC planner cache
  window.__KW_CACHE__ = kw;
}

function pagePlanner(){
  const wrap=el('div');
  wrap.appendChild(el('div',{class:'row'},
    el('div',{class:'card'},
      el('h3',null,'PPC Ad Group Plan'),
      el('div',{id:'agWrap'}),
      el('div',{class:'small'},'Derived from keyword list + CPL targets')
    ),
    el('div',{class:'card'},
      el('h3',null,'Budget & Conversions Forecast'),
      el('div',{id:'ppcForecast'})
    )
  ));
  setTimeout(()=> buildPlanner(), 0);
  return wrap;
}

function groupKeywords(kw){
  const groups={};
  kw.forEach(k=>{ const g = (k.service||'General Restoration'); (groups[g]=groups[g]||[]).push(k); });
  return groups;
}

function buildPlanner(){
  const kw = window.__KW_CACHE__ || KWSEED;
  const groups = groupKeywords(kw);
  const agWrap = document.getElementById('agWrap'); agWrap.innerHTML='';
  const t=el('table'); t.innerHTML='<tr><th>Ad Group</th><th>Keywords</th><th>Bid Hint</th></tr>';
  Object.keys(groups).forEach(g=>{
    const list=groups[g].slice(0,10).map(r=> r.keyword).join(', ');
    const avgCPC = Math.round((groups[g].reduce((s,r)=> s+(r.cpc||10),0) / groups[g].length) || 10);
    const tr=el('tr'); tr.appendChild(el('td',null,g)); tr.appendChild(el('td',null,list)); tr.appendChild(el('td',null,'$'+avgCPC));
    t.appendChild(tr);
  });
  agWrap.appendChild(t);

  // Forecast
  const plan = counterPlanFor(DATA.companies[0]);
  // Assume 60% of PPC allocation goes to Water Damage group by default
  const ppcBudget = Math.round(plan.budget * plan.mix.PPC);
  const avgCPC = Math.round((kw.reduce((s,r)=> s+(r.cpc||10),0) / kw.length) || 10);
  const estClicks = Math.max(1, Math.floor(ppcBudget / Math.max(1,avgCPC)));
  const ctr = 0.06, convRate = 0.10; // conservative
  const estLeads = Math.floor(estClicks * convRate);
  const cpl = estLeads ? Math.round(ppcBudget/estLeads) : ppcBudget;
  const fc=el('table'); fc.innerHTML='<tr><th>Budget</th><th>Avg CPC</th><th>Clicks</th><th>Conv. Rate</th><th>Leads</th><th>CPL</th></tr>'
    +'<tr><td>'+fmt.money(ppcBudget)+'</td><td>$'+avgCPC+'</td><td>'+estClicks+'</td><td>'+Math.round(convRate*100)+'%</td><td>'+estLeads+'</td><td>$'+cpl+'</td></tr>';
  document.getElementById('ppcForecast').innerHTML=''; document.getElementById('ppcForecast').appendChild(fc);
}

function pageSettings(){
  const wrap=el('div');
  wrap.appendChild(el('div',{class:'card'},
    el('h3',null,'Keyword Source (no backend)'),
    el('div',{class:'small'},'Optionally set a JSON URL (e.g., GitHub raw or Gist). The app will fetch it when Live is ON.'),
    el('input',{id:'kwUrl',class:'input',placeholder:'https://raw.githubusercontent.com/.../keywords.json'}),
    el('button',{id:'saveKw',class:'btn',style:'margin-top:8px'},'Save')
  ));
  wrap.appendChild(el('div',{class:'card',style:'margin-top:12px'},
    el('h3',null,'Economics (read-only here — edit assets/config.js to change)'),
    econTable()
  ));
  return wrap;
}

// ----- Router -----
function render(page){
  const host=document.getElementById('page'); host.innerHTML='';
  const routes={dashboard:pageDashboard, competitors:pageCompetitors, keywords:pageKeywords, planner:pagePlanner, settings:pageSettings};
  host.appendChild(routes[page||'dashboard']());
}

// ----- Init & Events -----
function init(){
  // Sidebar nav
  document.querySelectorAll('.side-item').forEach(n=> n.addEventListener('click', ()=> navActivate(n.getAttribute('data-page')) ));
  // Search
  document.getElementById('searchBox').addEventListener('input', (e)=>{
    const s=e.target.value.trim().toLowerCase();
    const grid=document.querySelector('.row3'); if(!grid) return;
    if(!s){ return render('competitors'); }
    const res = DATA.companies.filter(c=> c.name.toLowerCase().includes(s) || (c.city||'').toLowerCase().includes(s));
    grid.innerHTML=''; res.forEach(c=> grid.appendChild(companyTile(c)));
  });
  // Live toggle
  document.getElementById('toggleLive').addEventListener('change', (e)=>{ LIVE = !!e.target.checked; });
  // Add competitor
  document.getElementById('btnAdd').addEventListener('click', ()=>{
    const name=document.getElementById('newName').value.trim();
    const city=document.getElementById('newCity').value.trim();
    const website=document.getElementById('newWebsite').value.trim();
    if(!name||!city){ document.getElementById('addMsg').textContent='Name + City required.'; return; }
    const id=name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    if(DATA.companies.some(c=> c.id===id)){ document.getElementById('addMsg').textContent='That company exists.'; return; }
    const base={"id":id,"name":name,"logo":(name.split(' ').map(s=>s[0]).join('').slice(0,3)).toUpperCase(),"website":website,"city":city,"threatRank":(DATA.companies.length+1),
      "kpis":{"seo":0,"rating":0,"reviews":0,"adSpend":0,"localPack":0,"price":3,"quality":3},
      "mix":{"seo":25,"paid":25,"social":25,"referral":25},
      "ratingBreakdown":{"5★":0,"4★":0,"3★":0,"2★":0,"1★":0},
      "keywords":[],"trends":{"months":["Mar","Apr","May","Jun","Jul","Aug"],"adSpend":[0,0,0,0,0,0],"seo":[0,0,0,0,0,0],"localPack":[0,0,0,0,0,0]}
    };
    DATA.companies.push(base); document.getElementById('addMsg').textContent='Added locally.';
  });
  // Keywords page actions
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='btnReload'){ loadKeywordsUI(); }
  });
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='fileInput'){
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ try{ const parsed=JSON.parse(reader.result); if(Array.isArray(parsed)){ window.__KW_CACHE__=parsed; render('keywords'); } }catch(err){} };
      reader.readAsText(file);
    }
  });
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='saveKw'){
      const v=document.getElementById('kwUrl').value.trim(); if(v){ window.KEYWORD_JSON_URL=v; alert('Saved in this session. To persist, set KEYWORD_JSON_URL in assets/config.js'); }
    }
  });
  render('dashboard');
}

window.addEventListener('DOMContentLoaded', init);
</script>

<!-- Data seeds -->
</body>
</html>
