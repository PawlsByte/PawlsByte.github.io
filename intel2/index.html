<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AmeriClean Intel Hub — Enterprise v3</title>
<meta name="color-scheme" content="dark">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0f17;--panel:#0f1624;--text:#e7f2ff;--muted:#9cb4cc;--line:#1c2944;--hi:#7afcff;--hi2:#4bb3fd;--good:#1ecb7d;--bad:#ff6b6b;--warn:#ffd166}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto}
a{color:#a9d5ff;text-decoration:none}
.topbar{position:sticky;top:0;z-index:20;display:flex;gap:10px;align-items:center;padding:10px 14px;background:#0d1422;border-bottom:1px solid var(--line)}
.logo{width:28px;height:28px;border-radius:8px;background:#0e172b;display:grid;place-items:center;font-weight:700}
.layout{display:grid;grid-template-columns:300px 1fr;min-height:100dvh}
.sidebar{background:#0d1524;border-right:1px solid var(--line);padding:12px;position:sticky;top:48px;height:calc(100dvh - 48px);overflow:auto}
.side-item{padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1a2e;margin-bottom:8px;cursor:pointer}
.side-item.active{outline:1px solid #35659a}
.main{padding:16px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{padding:10px;border:1px solid #203255;border-radius:12px;background:linear-gradient(180deg,#101a2e,#0e1626)}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #254168;background:#0e1b30;color:#cfe6ff;margin-right:6px}
.btn{cursor:pointer;padding:6px 10px;border-radius:8px;border:1px solid #2a466f;background:#0f1a2b;color:#cfe6ff}
.btn.ghost{background:#0c1320;border-color:#263a5c}
.input{width:100%;padding:8px;border-radius:8px;border:1px solid #2a3c5c;background:#0e1830;color:#dfeeff}
.small{font-size:12px;color:var(--muted)}
.badge{padding:2px 6px;border-radius:6px;border:1px solid #204060;background:#132033}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #20314f}th{background:#0f1b2d;color:#bfe0ff;text-align:left}
hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.tabs{display:flex;gap:6px;margin-top:8px}.tab{padding:8px 10px;border:1px solid #243a60;border-radius:8px;background:#0f1a2c;cursor:pointer}.tab.active{outline:1px solid #35659a}
.notice{padding:8px;border:1px dashed #2a3f64;border-radius:8px;background:#0d172a}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tag{display:inline-block;padding:2px 6px;border:1px solid #30537f;border-radius:6px;background:#0f1c30;color:#cfe6ff}
@media print{.topbar,.sidebar,.tabs,.btn{display:none!important}.card{border:0}.print-page{page-break-after:always}}
</style>
<script src="assets/config.js"></script>
</head>
<body>
<div class="topbar">
  <div class="logo">AC</div><b>AmeriClean Intel Hub — Enterprise v3</b>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <input id="searchBox" class="input" style="width:260px" placeholder="Search competitors…">
    <select id="modelMode" class="input" style="width:200px">
      <option value="local">Model: Local Engine</option>
      <option value="urls">Model: Provider URLs</option>
      <option value="upload">Model: Upload Files</option>
    </select>
    <button id="btnRecompile" class="btn">Recompile Master Plan</button>
    <button id="btnPrintView" class="btn ghost">Print Current View</button>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <div class="small" style="margin:8px 0">Navigation</div>
    <div class="side-item active" data-page="dashboard">Dashboard</div>
    <div class="side-item" data-page="competitors">Competitors</div>
    <div class="side-item" data-page="keywords">Keywords</div>
    <div class="side-item" data-page="funnel">Market Funnel</div>
    <div class="side-item" data-page="master">Master Strategy</div>
    <div class="side-item" data-page="data">Data Manager</div>
    <div class="side-item" data-page="help">Help</div>

    <div class="small" style="margin:12px 0 6px">Add competitor</div>
    <input id="newName" class="input" placeholder="Company">
    <input id="newCity" class="input" placeholder="City, ST" style="margin-top:6px">
    <input id="newWebsite" class="input" placeholder="https://example.com" style="margin-top:6px">
    <button id="btnAdd" class="btn" style="margin-top:6px">Add</button>
    <div id="addMsg" class="small" style="margin-top:6px"></div>
  </aside>

  <main class="main">
    <div id="page"></div>
  </main>
</div>

<script>
// ===== Load data =====
async function getJSON(url){ const r=await fetch(url, {mode:'cors'}); if(!r.ok) throw new Error('fetch '+url); return r.json(); }
let DATA = await getJSON('data/competitors.json');
let ECON = await getJSON('data/economics.json');
let KWSEED = (await getJSON('data/keywords.json')).keywords;
let MODE='local';
let PROVIDERS={ list:['gemini','o3','gpt5','gpt5pro'], urls:(window.PROVIDER_URLS||{}), cache:{} };
let KEYWORD_URL = window.KEYWORD_JSON_URL || '';

// ===== Utils & lightweight charts =====
const fmt={money:(v)=>'$'+(Math.round(v).toLocaleString())};
function el(t,a){const e=document.createElement(t);a=a||{};for(const k in a){if(k==='class')e.className=a[k];else if(k==='html')e.innerHTML=a[k];else if(k==='onclick')e.onclick=a[k];else e.setAttribute(k,a[k]);}for(let i=2;i<arguments.length;i++){const ch=arguments[i];if(ch==null)continue;if(typeof ch==='string')e.appendChild(document.createTextNode(ch));else e.appendChild(ch);}return e;}
function bar(w,h,vals,labels){const m=Math.max(...vals,1),bw=Math.max(6,Math.floor((w-60)/vals.length)-6);let x=40,b=[];b.push('<svg width="'+w+'" height="'+h+'"><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7afcff"/><stop offset="100%" stop-color="#286b8e"/></linearGradient></defs>');for(let i=0;i<vals.length;i++){const v=vals[i],bh=Math.max(2,Math.round((v/m)*(h-50))),y=h-bh-20;b.push('<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+bh+'" rx="3" ry="3" fill="url(#g)"></rect>');if(labels)b.push('<text x="'+(x+bw/2)+'" y="'+(h-6)+'" fill="#9fb7cc" font-size="11" text-anchor="middle">'+labels[i]+'</text>');x+=bw+10;}b.push('</svg>');return b.join('');}
function line(labels,series,w,h){w=w||520;h=h||220;const pad=36,max=Math.max(...series,1),min=Math.min(...series,0),range=(max-min)||1;const sx=i=> pad+(i/(labels.length-1))*(w-2*pad);const sy=v=> h-pad-((v-min)/range)*(h-2*pad);let p='';for(let i=0;i<series.length;i++){p+=(i?' L':'M')+sx(i)+' '+sy(series[i]);}let dots='';for(let j=0;j<series.length;j++){dots+='<circle cx="'+sx(j)+'" cy="'+sy(series[j])+'" r="3" fill="#7afcff" stroke="#14304f"></circle>';}let xAxis='';for(let k=0;k<labels.length;k++){xAxis+='<text x="'+sx(k)+'" y="'+(h-4)+'" font-size="11" fill="#9fb7cc" text-anchor="middle">'+labels[k]+'</text>';}return '<svg width="'+w+'" height="'+h+'"><path d="'+p+'" fill="none" stroke="#4bb3fd" stroke-width="2"></path>'+dots+xAxis+'</svg>';}

// ===== Threat score =====
function threatScore(c){const k=c.kpis; let s=0; s+=k.seo*0.35; s+=(k.reviews/10.0)*0.25; s+=((6-k.localPack)*10)*0.20; s+=(k.adSpend/1000.0)*0.20; if(c.brand==='Franchise'||c.brand==='Regional') s+=8; return Math.round(s*10)/10;}
function recomputeRanks(){ DATA.companies.filter(c=>c.id!=='americlean').forEach(c=> c.threatScore=threatScore(c)); DATA.companies.filter(c=>c.id!=='americlean').sort((a,b)=>b.threatScore-a.threatScore).forEach((c,i)=> c.threatRank=i+1); }
recomputeRanks();

// ===== Local planning engine =====
function localPlanFor(c){
  const me = DATA.companies.find(x=>x.id==='americlean')||c;
  let budget = Math.max(3000, Math.round((c.kpis.adSpend*0.55)+(c.kpis.seo*30)+(c.kpis.reviews*3.0)));
  let mix={PPC:0.36,LSAs:0.22,LocalSEO:0.26,PaidSocial:0.08,CRO:0.08};
  if(c.kpis.localPack<=2){ mix.PPC=0.42; mix.LSAs=0.25; mix.LocalSEO=0.20; mix.PaidSocial=0.08; mix.CRO=0.05; }
  const s=mix.PPC+mix.LSAs+mix.LocalSEO+mix.PaidSocial+mix.CRO; Object.keys(mix).forEach(k=> mix[k]=+(mix[k]/s).toFixed(2));
  const cpl={}; Object.keys(ECON).forEach(sv=>{ const e=ECON[sv], gp=e.grossMargin*e.avgTicket, maxCAC=gp*0.45; cpl[sv]=Math.round((maxCAC*e.closeRate)/3); });
  return {budget,mix,cpl};
}

// ===== Provider merge =====
async function loadProviders(){
  if(MODE==='local'){PROVIDERS.cache={};return{};}
  const out={};
  for(const name of PROVIDERS.list){
    try{
      if(MODE==='urls' && (window.PROVIDER_URLS||{})[name]){
        const r=await fetch(window.PROVIDER_URLS[name],{mode:'cors'}); if(r.ok){ out[name]=await r.json(); localStorage.setItem('provider:'+name, JSON.stringify(out[name])); continue; }
      }
      const cached=localStorage.getItem('provider:'+name); if(cached) out[name]=JSON.parse(cached);
    }catch(e){}
  }
  PROVIDERS.cache=out; return out;
}
function aggMedian(nums){const arr=nums.filter(n=>typeof n==='number').sort((a,b)=>a-b); if(!arr.length) return 0; const m=Math.floor(arr.length/2); return arr.length%2?arr[m]:Math.round((arr[m-1]+arr[m])/2);}
function aggMix(mixes){ const sum={PPC:0,LSAs:0,LocalSEO:0,PaidSocial:0,CRO:0}; let n=0; mixes.forEach(m=>{ if(!m) return; n++; Object.keys(sum).forEach(k=> sum[k]+= (m[k]||0)); }); if(!n) return sum; Object.keys(sum).forEach(k=> sum[k]=+(sum[k]/n).toFixed(2)); const s=sum.PPC+sum.LSAs+sum.LocalSEO+sum.PaidSocial+sum.CRO; if(s){ Object.keys(sum).forEach(k=> sum[k]=+(sum[k]/s).toFixed(2)); } return sum; }
function dedupe(arr){ const seen={}; return (arr||[]).filter(t=>{const k=(t||'').toLowerCase(); if(!k||seen[k]) return false; seen[k]=1; return true;}); }
function unionKeywords(lists){ const map={}; lists.forEach(L=> (L||[]).forEach(r=>{ const key=(r.keyword||'').toLowerCase(); if(!key) return; if(!map[key]) map[key]=Object.assign({},r); else{ map[key].volume=Math.max(map[key].volume||0, r.volume||0); map[key].cpc=Math.max(map[key].cpc||0, r.cpc||0); map[key].intent=map[key].intent||r.intent; map[key].service=map[key].service||r.service; } })); return Object.values(map).sort((a,b)=>(b.volume||0)-(a.volume||0)); }

async function recompile(){
  const prov = await loadProviders();
  const merged={};
  for(const c of DATA.companies){
    const parts=[];
    parts.push({provider:'local', plan:localPlanFor(c), tactics:(c.profile? [c.profile.seoNotes, c.profile.socialNotes, c.profile.adCopy] : []), keywords:KWSEED});
    for(const name of Object.keys(prov)){
      const d=prov[name]; if(d && d.competitors && d.competitors[c.id]){
        const pc=d.competitors[c.id]; parts.push({provider:name, plan:{budget:pc.budget, mix:pc.mix}, tactics:pc.tactics||[], keywords:pc.keywords||[]});
      }
    }
    const budget = aggMedian(parts.map(p=> p.plan && p.plan.budget).filter(Boolean));
    const mix = aggMix(parts.map(p=> p.plan && p.plan.mix));
    const tactics = dedupe([].concat(...parts.map(p=> p.tactics||[])));
    const kwAll = unionKeywords([].concat(...parts.map(p=> p.keywords||[])));
    merged[c.id]={budget,mix,tactics,keywords:kwAll,byModel:parts};
  }
  const masterBudget = aggMedian(Object.values(merged).map(m=>m.budget));
  const masterMix = aggMix(Object.values(merged).map(m=>m.mix));
  const masterKeywords = unionKeywords([].concat(...Object.values(merged).map(m=>m.keywords)));
  window.MASTER_PLAN={generatedAt:new Date().toISOString(), providers:Object.keys(prov), merged, master:{budget:masterBudget,mix:masterMix,topKeywords:masterKeywords.slice(0,25)}};
}

// ===== Views =====
function sectionTitle(txt){return el('div',null, el('h3',null,txt));}
function kpi(label,value,sub){return el('div',{class:'kpi'}, el('div',null,label), el('b',null,value), sub? el('div',{class:'small'},sub): null );}

function pageDashboard(){
  const wrap=el('div');
  const me=DATA.companies.find(x=>x.id==='americlean')||DATA.companies[0];
  const rivals=DATA.companies.filter(c=>c.id!=='americlean').slice().sort((a,b)=>a.threatRank-b.threatRank);
  const top=rivals[0];
  const row=el('div',{class:'row3'});
  row.appendChild(kpi('Top Threat', top? top.name:'—', top? ('Threat Score '+top.threatScore):''));
  row.appendChild(kpi('AmeriClean SEO', (me.kpis.seo||0)+' / 100', 'Goal: +15 in 90 days'));
  row.appendChild(kpi('Spend Gap vs Top', fmt.money(Math.max(0,(top?.kpis.adSpend||0)-(me.kpis.adSpend||0))), 'Monthly gap'));
  wrap.appendChild(row);

  const charts=el('div',{class:'row'});
  charts.appendChild(el('div',{class:'card'}, sectionTitle('Threat Spend Trend (6 mo)'), el('div',{html:line((top?.trends.months||[]),(top?.trends.adSpend||[]),520,240)})));
  charts.appendChild(el('div',{class:'card'}, sectionTitle('AmeriClean SEO Trend'), el('div',{html:line(me.trends.months, me.trends.seo,520,240)})));
  wrap.appendChild(charts);

  // SOV estimate panel
  const totalVol = KWSEED.reduce((s,r)=>s+(r.volume||0),0);
  const sov=el('div',{class:'row'});
  sov.appendChild(el('div',{class:'card'}, sectionTitle('Local Demand (Search Volume)'), el('b',null, (totalVol.toLocaleString())+' / mo'), el('div',{class:'small'},'Across top service terms in Billings')));
  const spend=el('div',{class:'card'}, sectionTitle('Estimated PPC Clicks (AmeriClean)'), (function(){ const p=localPlanFor(me); const ppc=Math.round(p.budget*(p.mix.PPC||0)); const avgCPC=Math.round((KWSEED.reduce((s,r)=>s+(r.cpc||10),0)/KWSEED.length)||10); const clicks=Math.max(1, Math.floor(ppc/Math.max(1,avgCPC))); return el('div',null, el('b',null, clicks+' / mo'), el('div',{class:'small'}, fmt.money(ppc)+' @ ~$'+avgCPC+' CPC')); })()));
  wrap.appendChild(sov);

  wrap.appendChild(el('hr'));
  wrap.appendChild(el('div',{class:'notice'}, 'Tip: Use the model selector (top). Local = built-in. Provider URLs = JSON links in assets/config.js. Upload = drop model JSONs, then Recompile.'));
  return wrap;
}

function competitorCard(c){
  const k=c.kpis;
  const card=el('div',{class:'card'});
  card.appendChild(el('div',null, el('b',null,c.name),' ', el('span',{class:'badge'},c.brand), ' ', el('span',{class:'badge'},c.city)));
  card.appendChild(el('div',{class:'small'}, c.website||''));
  card.appendChild(el('div',{html:bar(360,160,[k.seo,(k.rating||0)*20,(k.reviews||0)/10,(k.adSpend||0)/500], ['SEO','★','Rev','Ad$'])}));
  card.appendChild(el('div',null, el('span',{class:'pill'},'Threat #'+(c.threatRank||'?')), el('span',{class:'pill'},'Score '+(c.threatScore||'?')) ));
  const btn=el('a',{href:'#/competitor/'+c.id, class:'btn'},'Open Strategy');
  card.appendChild(el('div',{style:'margin-top:8px'}, btn));
  return card;
}

function pageCompetitors(){
  const wrap=el('div');
  const controls=el('div',{class:'flex card'}, el('div',null,'Filters:'),
    el('select',{id:'brandFilter',class:'input',style:'width:180px'}, el('option',{value:''},'All brands'),el('option',{value:'Franchise'},'Franchise'),el('option',{value:'Local'},'Local'),el('option',{value:'Regional'},'Regional')),
    el('select',{id:'sortBy',class:'input',style:'width:180px'}, el('option',{value:'threat'},'Sort: Threat'), el('option',{value:'seo'},'Sort: SEO'), el('option',{value:'ad'},'Sort: Ad Spend'), el('option',{value:'reviews'},'Sort: Reviews')));
  wrap.appendChild(controls);
  const grid=el('div',{class:'row3', id:'compGrid'});
  wrap.appendChild(grid);
  function draw(){
    const brand=(document.getElementById('brandFilter').value||'').toLowerCase();
    const by=document.getElementById('sortBy').value;
    grid.innerHTML='';
    let list=DATA.companies.filter(c=>c.id!=='americlean');
    if(brand) list=list.filter(c=> (c.brand||'').toLowerCase()===brand);
    list.sort((a,b)=>{
      if(by==='seo') return b.kpis.seo-a.kpis.seo;
      if(by==='ad') return b.kpis.adSpend-a.kpis.adSpend;
      if(by==='reviews') return b.kpis.reviews-a.kpis.reviews;
      return a.threatRank-b.threatRank;
    });
    list.forEach(c=> grid.appendChild(competitorCard(c)));
  }
  controls.querySelectorAll('select').forEach(s=> s.addEventListener('change', draw));
  draw();
  wrap.appendChild(el('hr'));
  const detail=el('div',{id:'compDetail'}); wrap.appendChild(detail);
  return wrap;
}

function compTabs(active, setActive){
  const names=['Snapshot','Service Areas','SEO & Content','Paid Media','Social & Reviews','Local Pack & GBP','Counter Plan','Action Plan'];
  const bar=el('div',{class:'tabs'});
  names.forEach(n=>{ const t=el('div',{class:'tab'+(n===active?' active':''), 'data-tab':n}, n); t.addEventListener('click', ()=> setActive(n)); bar.appendChild(t); });
  return bar;
}

function renderCompetitorDetail(id){
  const c=DATA.companies.find(x=>x.id===id); if(!c) return;
  const host=document.getElementById('compDetail')||document.getElementById('page'); host.innerHTML='';
  host.appendChild(el('div',{class:'card print-page'}, el('h2',null,c.name,' ', el('span',{class:'badge'},c.brand),' ', el('span',{class:'badge'},c.city)), el('div',{class:'small'}, el('a',{href:c.website,target:'_blank'}, c.website)), el('div',null, el('button',{class:'btn',onclick:()=>window.print()},'Print This Competitor'))));
  let active='Snapshot'; const content=el('div'); function setActive(tab){ active=tab; draw(); }
  host.appendChild(compTabs(active,setActive)); host.appendChild(content);

  function draw(){
    content.innerHTML='';
    if(active==='Snapshot'){
      const me=DATA.companies.find(x=>x.id==='americlean');
      const row=el('div',{class:'row'});
      row.appendChild(el('div',{class:'card'}, sectionTitle('KPI vs AmeriClean'),
        el('table',{html:'<tr><th>Metric</th><th>'+c.name+'</th><th>AmeriClean</th><th>Gap</th></tr>'
          +'<tr><td>SEO</td><td>'+c.kpis.seo+'</td><td>'+me.kpis.seo+'</td><td>'+(c.kpis.seo-me.kpis.seo)+'</td></tr>'
          +'<tr><td>Avg Rating</td><td>'+c.kpis.rating+'</td><td>'+me.kpis.rating+'</td><td>'+((c.kpis.rating-me.kpis.rating).toFixed(1))+'</td></tr>'
          +'<tr><td>Reviews</td><td>'+c.kpis.reviews+'</td><td>'+me.kpis.reviews+'</td><td>'+(c.kpis.reviews-me.kpis.reviews)+'</td></tr>'
          +'<tr><td>Est. Ad Spend</td><td>'+fmt.money(c.kpis.adSpend)+'</td><td>'+fmt.money(me.kpis.adSpend)+'</td><td>'+fmt.money(c.kpis.adSpend-me.kpis.adSpend)+'</td></tr>'
          +'<tr><td>Local Pack Rank</td><td>'+c.kpis.localPack+'</td><td>'+me.kpis.localPack+'</td><td>'+(c.kpis.localPack-me.kpis.localPack)+'</td></tr>'
        })
      ));
      row.appendChild(el('div',{class:'card'}, sectionTitle('Trends'),
        el('div',{html:line(c.trends.months, c.trends.adSpend, 520, 220)}), el('div',{class:'small'},'Ad Spend (6 mo)')));
      content.appendChild(row);
      content.appendChild(el('div',{class:'card'}, sectionTitle('Observed Strategy'), el('ul',null,
        el('li',null,'Positioning: ', c.profile.positioning||''),
        el('li',null,'Primary Channels: ', (c.profile.channels||[]).join(', ')),
        el('li',null,'SEO Notes: ', c.profile.seoNotes||''),
        el('li',null,'Social Notes: ', c.profile.socialNotes||'')
      )));
    }
    if(active==='Service Areas'){
      content.appendChild(el('div',{class:'card'}, sectionTitle('Service Areas'), el('div',{class:'flex'}, ...(c.serviceAreas||[]).map(s=> el('span',{class:'tag'},s)) )));
      content.appendChild(el('div',{class:'card'}, sectionTitle('Services Offered'), el('div',{class:'flex'}, ...(c.services||[]).map(s=> el('span',{class:'tag'},s)) )));
      content.appendChild(el('div',{class:'card'}, sectionTitle('Links'), el('div',null, el('a',{href:c.website,target:'_blank'},'Website →'), ' ', c.social?.facebook? el('a',{href:c.social.facebook,target:'_blank',style:'margin-left:12px'},'Facebook →'): el('span',{class:'small'},'No social link noted'))));
    }
    if(active==='SEO & Content'){
      const kw= (window.MASTER_PLAN?.merged?.[c.id]?.keywords) || KWSEED;
      const table=el('table'); table.innerHTML='<tr><th>Keyword</th><th>Volume</th><th>CPC</th><th>Intent</th><th>Service</th></tr>';
      kw.slice(0,20).forEach(r=>{ const tr=el('tr'); tr.appendChild(el('td',null,r.keyword)); tr.appendChild(el('td',null,String(r.volume||0))); tr.appendChild(el('td',null,r.cpc? '$'+r.cpc.toFixed(2):'—')); tr.appendChild(el('td',null,r.intent||'')); tr.appendChild(el('td',null,r.service||'')); table.appendChild(tr); });
      content.appendChild(el('div',{class:'card'}, sectionTitle('Keyword Demand (Top 20)'), table));
      const contentGaps=['Sewage cleanup (page + FAQs)','Basement flood cleanup (local photos)','Smoke odor removal (service page)','Emergency after-hours page (call-only CTA)','Suburb geo pages (Laurel, Lockwood, Heights)'];
      content.appendChild(el('div',{class:'card'}, sectionTitle('Content Gaps (Likely)'), el('ul',null, ...contentGaps.map(t=> el('li',null,t)) )));
    }
    if(active==='Paid Media'){
      const kw=(window.MASTER_PLAN?.merged?.[c.id]?.keywords)||KWSEED;
      const p=localPlanFor(c); const ppc=Math.round(p.budget*(p.mix.PPC||0)); const avgCPC=Math.round((kw.reduce((s,r)=>s+(r.cpc||10),0)/kw.length)||10); const clicks=Math.max(1, Math.floor(ppc/Math.max(1,avgCPC)));
      const labels=kw.slice(0,8).map(x=> x.keyword.length>16? x.keyword.slice(0,16)+'…':x.keyword); const vals=kw.slice(0,8).map(x=> x.volume||0);
      const row=el('div',{class:'row'});
      row.appendChild(el('div',{class:'card'}, sectionTitle('Top Keywords by Volume'), el('div',{html:bar(520,220,vals,labels)})));
      row.appendChild(el('div',{class:'card'}, sectionTitle('Budget → Clicks → Leads (Est.)'), (function(){ const conv=0.10; const leads=Math.floor(clicks*conv); const t=el('table'); t.innerHTML='<tr><th>PPC Budget</th><th>Avg CPC</th><th>Clicks</th><th>Leads @10%</th></tr>'+'<tr><td>'+fmt.money(ppc)+'</td><td>$'+avgCPC+'</td><td>'+clicks+'</td><td>'+leads+'</td></tr>'; return t; })()));
      content.appendChild(row);
      content.appendChild(el('div',{class:'card'}, sectionTitle('Ad Copy Angle (Example)'), el('div',{class:'small'}, c.profile.adCopy||'')));
    }
    if(active==='Social & Reviews'){
      const rb=c.ratingBreakdown||{};
      const row=el('div',{class:'row'});
      row.appendChild(el('div',{class:'card'}, sectionTitle('Ratings Distribution'), el('div',{html:bar(420,200, Object.values(rb), Object.keys(rb))})));
      row.appendChild(el('div',{class:'card'}, sectionTitle('Social Cadence (posts/mo)'), el('div',{html:line(c.social.months, c.social.posts, 520, 200)})));
      content.appendChild(row);
      content.appendChild(el('div',{class:'card'}, sectionTitle('Engagement Trend'), el('div',{html:line(c.social.months, c.social.engagement, 820, 200)})));
    }
    if(active==='Local Pack & GBP'){
      const row=el('div',{class:'row'});
      row.appendChild(el('div',{class:'card'}, sectionTitle('Local Pack Rank (lower=better)'), el('div',{html:line(c.trends.months, c.trends.localPack, 520, 200)})));
      row.appendChild(el('div',{class:'card'}, sectionTitle('GBP Checklist'),
        el('ul',null,
          el('li',null,'100% services + emergency attributes'),
          el('li',null,'Weekly posts (before/after, offers, Q&A)'),
          el('li',null,'Fresh photos monthly (jobs, team, vehicles)'),
          el('li',null,'Call tracking; message enabled; after-hours routing')
        )
      ));
      content.appendChild(row);
    }
    if(active==='Counter Plan'){
      const plan=(window.MASTER_PLAN?.merged?.[c.id])||{budget:localPlanFor(c).budget, mix:localPlanFor(c).mix, tactics:[]};
      const labels=Object.keys(plan.mix), vals=labels.map(k=> Math.round((plan.budget||0)*(plan.mix[k]||0)));
      const grid=el('div',{class:'row'});
      grid.appendChild(el('div',{class:'card'}, sectionTitle('Recommended Monthly Budget'), el('b',null, fmt.money(plan.budget||0))));
      grid.appendChild(el('div',{class:'card'}, sectionTitle('Spend Allocation'), el('div',{html:bar(520,200,vals,labels)})));
      content.appendChild(grid);
      const tactics = plan.tactics?.length? plan.tactics : ['Launch exact-match emergency PPC + LSAs (7pm–7am call-only)','Publish sewage/dry-out/smoke odor pages + FAQs','CRO: sticky call CTA; 60‑minute arrival promise','GBP: weekly posts/photos; enable messaging','Reviews: +20 in 60 days via automation'];
      content.appendChild(el('div',{class:'card'}, sectionTitle('Tactics (Merged)'), el('ul',null, ...(tactics.map(t=> el('li',null,t))) )));
    }
    if(active==='Action Plan'){
      const t=el('table'); t.innerHTML='<tr><th>Phase</th><th>Action</th><th>Owner</th><th>Target</th></tr>'
        +'<tr><td>Week 1</td><td>Launch emergency PPC + LSAs</td><td>Marketing</td><td>5 leads/day</td></tr>'
        +'<tr><td>Week 2</td><td>Publish service & geo pages</td><td>SEO</td><td>Index in 7 days</td></tr>'
        +'<tr><td>Week 3</td><td>GBP posts + photos + Q&A</td><td>Social</td><td>3/wk</td></tr>'
        +'<tr><td>Week 4</td><td>Review campaign kickoff (+20/60d)</td><td>Ops</td><td>4.8★+</td></tr>';
      content.appendChild(el('div',{class:'card'}, sectionTitle('Execution Timeline'), t));
    }
  }
  draw();
}

async function fetchKeywords(city){
  const k='kw:'+city;
  if(KEYWORD_URL && MODE!=='local'){
    try{ const r=await fetch(KEYWORD_URL,{mode:'cors'}); if(r.ok){ const j=await r.json(); const arr=Array.isArray(j)?j:(j.keywords||[]); if(arr.length){ localStorage.setItem(k, JSON.stringify(arr)); return arr; } } }catch(e){}
  }
  try{ const cached=localStorage.getItem(k); if(cached) return JSON.parse(cached); }catch(e){}
  return KWSEED;
}

async function pageKeywords(){
  const me=DATA.companies.find(x=>x.id==='americlean')||DATA.companies[0];
  const kw=await fetchKeywords(me.city||'Billings, MT');
  const wrap=el('div');
  const t=el('table'); t.innerHTML='<tr><th>Keyword</th><th>Volume</th><th>CPC</th><th>Intent</th><th>Service</th></tr>';
  kw.forEach(r=>{ const tr=el('tr'); tr.appendChild(el('td',null,r.keyword)); tr.appendChild(el('td',null,String(r.volume||0))); tr.appendChild(el('td',null, r.cpc? '$'+r.cpc.toFixed(2):'—')); tr.appendChild(el('td',null, r.intent||'')); tr.appendChild(el('td',null, r.service||'')); t.appendChild(tr); });
  wrap.appendChild(el('div',{class:'card print-page'}, sectionTitle('Local Keyword Demand'), t));
  const top=kw.slice(0,10), labels=top.map(x=> x.keyword.length>16? x.keyword.slice(0,16)+'…':x.keyword), vals=top.map(x=> x.volume||0);
  wrap.appendChild(el('div',{class:'card'}, sectionTitle('Top Volume (bar)'), el('div',{html:bar(820,220,vals,labels)})));
  return wrap;
}

function pageFunnel(){
  const wrap=el('div');
  const totalVol = KWSEED.reduce((s,r)=>s+(r.volume||0),0);
  const avgCPC = Math.round((KWSEED.reduce((s,r)=>s+(r.cpc||10),0)/KWSEED.length)||10);
  const me=DATA.companies.find(x=>x.id==='americlean');
  const plan=localPlanFor(me); const ppc=Math.round(plan.budget*(plan.mix.PPC||0)); const clicks=Math.max(1, Math.floor(ppc/Math.max(1,avgCPC)));
  const conv=0.10, leads=Math.floor(clicks*conv);
  const row=el('div',{class:'row3'});
  row.appendChild(kpi('Search Demand (mo)', totalVol.toLocaleString()));
  row.appendChild(kpi('Clicks (est.)', clicks.toLocaleString(), fmt.money(ppc)+' @ ~$'+avgCPC+' CPC'));
  row.appendChild(kpi('Leads (est.)', leads.toString(), 'Conv 10%'));
  wrap.appendChild(row);
  wrap.appendChild(el('div',{class:'card'}, sectionTitle('How we compute'), el('div',{class:'small'}, 'We use conservative industry baselines. Replace with your data anytime via Data Manager or Provider URLs.')));
  return wrap;
}

function pageMaster(){
  const M=window.MASTER_PLAN||{master:{budget:0,mix:{}},merged:{}};
  const wrap=el('div');
  wrap.appendChild(el('div',{class:'row'},
    kpi('Master Budget (Median)', fmt.money(M.master.budget||0)),
    el('div',{class:'card'}, sectionTitle('Master Mix (Avg)'), el('div',{html:bar(520,160, Object.keys(M.master.mix||{}).map(k=> Math.round((M.master.budget||0)*(M.master.mix[k]||0))), Object.keys(M.master.mix||{}))}))
  ));
  const kw=(M.master.topKeywords||[]).slice(0,20); const t=el('table'); t.innerHTML='<tr><th>Keyword</th><th>Volume</th><th>CPC</th><th>Intent</th><th>Service</th></tr>'; kw.forEach(r=>{ const tr=el('tr'); tr.appendChild(el('td',null,r.keyword)); tr.appendChild(el('td',null,String(r.volume||0))); tr.appendChild(el('td',null, r.cpc? '$'+r.cpc.toFixed(2):'—')); tr.appendChild(el('td',null, r.intent||'')); tr.appendChild(el('td',null, r.service||'')); t.appendChild(tr); });
  wrap.appendChild(el('div',{class:'card print-page'}, sectionTitle('Top Keywords (Merged)'), t));
  wrap.appendChild(el('div',null, el('button',{class:'btn', onclick:()=>window.print()}, 'Print Master Strategy')));
  return wrap;
}

function pageData(){
  const wrap=el('div');
  wrap.appendChild(el('div',{class:'card'}, sectionTitle('Import Data (CSV/JSON)'), el('div',{class:'small'}, 'Drop files here to update competitors, keywords, or provider outputs (browser-only).'), el('div',{id:'drop',style:'border:1px dashed #2a3f64;padding:20px;border-radius:10px;margin-top:8px'}, 'Drop files here…')));
  const drop=()=>{
    const box=document.getElementById('drop');
    box.addEventListener('dragover', e=>{e.preventDefault(); box.style.background='#0c1526';});
    box.addEventListener('dragleave', e=>{box.style.background='transparent';});
    box.addEventListener('drop', async e=>{
      e.preventDefault(); box.style.background='transparent';
      for(const f of e.dataTransfer.files){
        const text=await f.text();
        try{
          const j=JSON.parse(text);
          if(j.competitors || (j.companies)){ DATA = j.companitors? j : j; localStorage.setItem('DATA', JSON.stringify(DATA)); alert('Competitors updated from '+f.name); }
          if(Array.isArray(j) || j.keywords){ const arr=Array.isArray(j)? j : j.keywords; localStorage.setItem('KW:'+ (DATA.companies.find(x=>x.id==='americlean')?.city||'Billings, MT'), JSON.stringify(arr)); alert('Keywords updated from '+f.name); }
          if(j.provider && j.competitors){ localStorage.setItem('provider:'+j.provider, JSON.stringify(j)); alert('Provider '+j.provider+' cached'); }
        }catch(ex){ console.log(ex); alert('Unsupported file: '+f.name); }
      }
    });
  };
  setTimeout(drop, 100);
  return wrap;
}

function pageHelp(){
  return el('div',null,
    el('div',{class:'card'}, sectionTitle('How to Use'), el('ol',null,
      el('li',null,'Open Competitors → pick a company → deep-dive tabs.'),
      el('li',null,'Use Counter Plan → get budget & channel mix.'),
      el('li',null,'Go to Master Strategy → merged plan & keywords.'),
      el('li',null,'Data Manager → import JSON/CSV (no backend).')
    ))
  );
}

// ===== Router =====
function render(page){
  const host=document.getElementById('page'); host.innerHTML='';
  if(page && page.startsWith('#/competitor/')){
    host.appendChild(pageCompetitors());
    renderCompetitorDetail(page.split('/')[2]);
    return;
  }
  const routes={dashboard:pageDashboard, competitors:pageCompetitors, keywords:()=>{pageKeywords().then(n=>host.appendChild(n)); return el('div');}, funnel:pageFunnel, master:pageMaster, data:pageData, help:pageHelp};
  host.appendChild(routes[page||'dashboard']());
}

// ===== Init UI =====
function syncModeUI(){ document.getElementById('modelMode').value=MODE; }
async function init(){
  document.querySelectorAll('.side-item').forEach(n=> n.addEventListener('click', ()=>{ document.querySelectorAll('.side-item').forEach(m=>m.classList.remove('active')); n.classList.add('active'); render(n.getAttribute('data-page')); } ));
  document.getElementById('modelMode').addEventListener('change', (e)=>{ MODE=e.target.value; syncModeUI(); });
  document.getElementById('btnRecompile').addEventListener('click', async ()=>{ await recompile(); alert('Master plan rebuilt. Open a competitor or Master Strategy.'); render('master'); });
  document.getElementById('btnPrintView').addEventListener('click', ()=> window.print() );
  document.getElementById('searchBox').addEventListener('input', (e)=>{
    const s=e.target.value.trim().toLowerCase(); const grid=document.getElementById('compGrid'); if(!grid) return;
    grid.innerHTML=''; DATA.companies.filter(c=> c.id==='americlean' || c.name.toLowerCase().includes(s) || (c.city||'').toLowerCase().includes(s)).filter(c=>c.id!=='americlean').sort((a,b)=>a.threatRank-b.threatRank).forEach(c=> grid.appendChild(competitorCard(c)));
  });
  // Add competitor
  document.getElementById('btnAdd').addEventListener('click', ()=>{
    const name=document.getElementById('newName').value.trim();
    const city=document.getElementById('newCity').value.trim();
    const website=document.getElementById('newWebsite').value.trim();
    if(!name||!city){ document.getElementById('addMsg').textContent='Name + City required.'; return; }
    const id=name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    if(DATA.companies.some(c=> c.id===id)){ document.getElementById('addMsg').textContent='That company exists.'; return; }
    const seed = {id,name,website,city,brand:'Local',services:[],serviceAreas:[],kpis:{seo:40,rating:4.8,reviews:0,adSpend:0,localPack:4},trends:{months:['Mar','Apr','May','Jun','Jul','Aug'],adSpend:[0,0,0,0,0,0],seo:[40,40,40,40,40,40],localPack:[4,4,4,4,4,4]},social:{months:['Mar','Apr','May','Jun','Jul','Aug'],posts:[0,0,0,0,0,0],engagement:[0,0,0,0,0,0]},ratingBreakdown:{'5★':0,'4★':0,'3★':0,'2★':0,'1★':0},profile:{positioning:'',channels:[],seoNotes:'',socialNotes:'',adCopy:''}};
    DATA.companies.push(seed); recomputeRanks(); document.getElementById('addMsg').textContent='Added locally.'; render('competitors');
  });
  if(location.hash && location.hash.startsWith('#/competitor/')){ render(location.hash); } else { render('dashboard'); }
  syncModeUI();
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body></html>
